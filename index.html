<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GALAXY WAR - MOBILE FIXED</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; touch-action: none; user-select: none; -webkit-user-select: none; }
        
        #hud {
            position: absolute; top: 10px; left: 10px;
            color: #00ffcc; font-family: 'Consolas', monospace;
            background: rgba(20, 20, 0, 0.8); /* Fundo amarelado */
            padding: 10px; border: 2px solid #ffff00; border-radius: 8px;
            pointer-events: none; width: 180px; z-index: 10; font-size: 12px;
        }
        
        #blocker {
            position: absolute; width: 100%; height: 100%;
            background: linear-gradient(135deg, #000000, #333300);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: white; font-family: sans-serif; z-index: 999; cursor: pointer; text-align: center;
        }
        
        .bar-container { width: 100%; background: #222; height: 10px; margin-top: 3px; border: 1px solid #555; }
        .bar { height: 100%; width: 100%; transition: width 0.1s; }
        
        /* MENSAGENS */
        .msg { position: absolute; width: 100%; text-align: center; display: none; pointer-events: none; font-weight: bold; font-family: sans-serif; }
        #msg-base { bottom: 20%; color: #ffff00; font-size: 20px; text-shadow: 0 0 10px yellow; }
        #rescue-ui { top: 40%; color: yellow; font-size: 18px; text-shadow: 0 0 5px red; animation: pulse 0.5s infinite; }
        #msg-hit { top: 30%; color: red; font-size: 40px; text-shadow: 0 0 20px red; }
        #damage-overlay { position: absolute; width: 100%; height: 100%; pointer-events: none; box-shadow: inset 0 0 0 0 red; transition: box-shadow 0.1s; z-index: 5; }
        
        @keyframes pulse { from { opacity: 0.5; } to { opacity: 1; } }

        /* --- CONTROLES MOBILE --- */
        .controls {
            position: absolute; bottom: 20px; width: 100%; height: 150px;
            pointer-events: none; display: flex; justify-content: space-between; padding: 0 30px; box-sizing: border-box; z-index: 20;
        }
        .dpad { width: 120px; height: 120px; position: relative; pointer-events: auto; }
        .btn {
            position: absolute; background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.4); border-radius: 50%;
            width: 45px; height: 45px; display: flex; justify-content: center; align-items: center;
            color: white; font-weight: bold; font-family: sans-serif;
        }
        .btn:active { background: rgba(0, 255, 255, 0.5); border-color: cyan; }
        #btn-up { top: 0; left: 37.5px; }
        #btn-down { bottom: 0; left: 37.5px; }
        #btn-left { top: 37.5px; left: 0; }
        #btn-right { top: 37.5px; right: 0; }

        .actions { width: 140px; height: 100px; position: relative; pointer-events: auto; display: flex; gap: 20px; align-items: flex-end; justify-content: flex-end; }
        .action-btn {
            width: 65px; height: 65px; border-radius: 50%; border: 2px solid white;
            display: flex; justify-content: center; align-items: center; font-size: 24px; color: white;
        }
        #btn-turbo { background: rgba(255, 165, 0, 0.3); border-color: orange; margin-bottom: 20px; width: 55px; height: 55px; }
        #btn-turbo:active { background: orange; }
        #btn-fire { background: rgba(255, 0, 0, 0.3); border-color: red; }
        #btn-fire:active { background: red; }
    </style>
</head>
<body>
    <div id="damage-overlay"></div>
    <div id="blocker">
        <h1>GALAXY WAR</h1>
        <p>TOQUE AQUI PARA INICIAR</p>
    </div>

    <div id="hud">
        STATUS<br>
        FUEL: <div class="bar-container"><div id="fuel-bar" class="bar" style="background: orange;"></div></div>
        LASER: <div class="bar-container"><div id="laser-bar" class="bar" style="background: cyan;"></div></div>
        <div id="online-status" style="color:lime; margin-top:5px">OFFLINE</div>
    </div>

    <div id="msg-base" class="msg">âš¡ REABASTECENDO âš¡</div>
    <div id="rescue-ui" class="msg">âš  PANE SECA! SOCORRO A CAMINHO...</div>
    <div id="msg-hit" class="msg">VOCÃŠ MORREU!</div>

    <div class="controls">
        <div class="dpad">
            <div id="btn-up" class="btn">W</div>
            <div id="btn-down" class="btn">S</div>
            <div id="btn-left" class="btn">A</div>
            <div id="btn-right" class="btn">D</div>
        </div>
        <div class="actions">
            <div id="btn-turbo" class="action-btn">âš¡</div>
            <div id="btn-fire" class="action-btn">ðŸ”«</div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }</script>

    <script type="module">
        import * as THREE from 'three';

        // --- MOBILE SETUP ---
        document.addEventListener('contextmenu', event => event.preventDefault());

        // --- SISTEMA ONLINE ---
        let socket;
        let isOnline = false;
        const otherPlayers = {}; 
        try { socket = io(); isOnline = true; } catch(e) { console.log("Offline"); }

        // --- AUDIO ---
        const audioSys = {
            ctx: null, isInit: false, engineGain: null, melodyInterval: null, noteIndex: 0,
            melody: [ 261.63, 0, 329.63, 0, 392.00, 0, 493.88, 0, 523.25, 0, 392.00, 0, 329.63, 0, 261.63, 0 ],
            init: function() {
                if(this.isInit) return;
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                // Motor
                const bSize = this.ctx.sampleRate * 2; const buf = this.ctx.createBuffer(1, bSize, this.ctx.sampleRate);
                const data = buf.getChannelData(0); for (let i = 0; i < bSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = this.ctx.createBufferSource(); noise.buffer=buf; noise.loop=true;
                const filter = this.ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value=600;
                this.engineGain = this.ctx.createGain(); this.engineGain.gain.value=0;
                noise.connect(filter); filter.connect(this.engineGain); this.engineGain.connect(this.ctx.destination);
                noise.start();
                // Musica
                setInterval(() => {
                    const freq = this.melody[this.noteIndex];
                    if(freq > 0) this.playBeep(freq);
                    this.noteIndex = (this.noteIndex + 1) % this.melody.length;
                }, 200);
                this.isInit = true;
            },
            playBeep: function(freq) {
                if(!this.ctx) return;
                const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                o.type='square'; o.frequency.setValueAtTime(freq, this.ctx.currentTime);
                g.gain.setValueAtTime(0.02, this.ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime+0.1);
                o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+0.1);
            },
            updateEngine: function(on) {
                if(this.isInit) this.engineGain.gain.setTargetAtTime(on ? 0.2 : 0, this.ctx.currentTime, 0.1);
            },
            shoot: function() {
                if(!this.isInit) return;
                const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                o.type='square'; o.frequency.setValueAtTime(600, this.ctx.currentTime); 
                o.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime+0.15);
                g.gain.setValueAtTime(0.05, this.ctx.currentTime); 
                g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime+0.15);
                o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+0.2);
            },
            explode: function() {
                if(!this.isInit) return;
                const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                o.type='sawtooth'; o.frequency.value=50; 
                g.gain.setValueAtTime(0.2, this.ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime+0.5);
                o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+0.5);
            }
        };

        // --- THREE.JS ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0x888888, 2));
        const sun = new THREE.DirectionalLight(0xffffff, 1.5); sun.position.set(50, 100, 50); scene.add(sun);

        // --- MUNDO ---
        const earth = new THREE.Mesh(new THREE.PlaneGeometry(128, 128), new THREE.MeshPhongMaterial({color: 0x112233}));
        earth.rotation.x = -Math.PI/2; scene.add(earth);
        const alien = new THREE.Mesh(new THREE.PlaneGeometry(128, 128), new THREE.MeshPhongMaterial({color: 0x440044}));
        alien.rotation.x = Math.PI/2; alien.position.y = 128; scene.add(alien);
        
        // Bases
        const padMat = new THREE.MeshBasicMaterial({color: 0xffff00});
        const pad1 = new THREE.Mesh(new THREE.PlaneGeometry(20,20), padMat); pad1.rotation.x = -Math.PI/2; pad1.position.y = 0.2; scene.add(pad1);
        const pad2 = new THREE.Mesh(new THREE.PlaneGeometry(20,20), padMat); pad2.rotation.x = Math.PI/2; pad2.position.y = 127.8; scene.add(pad2);
        
        const grid = new THREE.GridHelper(128, 8, 0x555555, 0x111111); grid.position.y = 64; scene.add(grid);

        // Props
        const targets = [];
        const treeGeo = new THREE.ConeGeometry(2, 6, 4); const treeMat = new THREE.MeshPhongMaterial({color: 0x00ff00});
        for(let i=0; i<15; i++) {
            const t = new THREE.Mesh(treeGeo, treeMat);
            t.position.set((Math.random()-0.5)*100, 3, (Math.random()-0.5)*100); scene.add(t); targets.push(t);
        }
        const alienTreeGeo = new THREE.ConeGeometry(1, 12, 4); const alienTreeMat = new THREE.MeshPhongMaterial({color: 0x00ffff});
        for(let i=0; i<15; i++) {
            const at = new THREE.Mesh(alienTreeGeo, alienTreeMat);
            at.position.set((Math.random()-0.5)*100, 125, (Math.random()-0.5)*100); at.rotation.z = Math.PI; scene.add(at); targets.push(at);
        }

        // --- NAVE ---
        const ship = new THREE.Group(); ship.position.set(0, 5, 0); scene.add(ship);
        function createShip(color) {
            const g = new THREE.Group();
            g.add(new THREE.Mesh(new THREE.BoxGeometry(1.5, 1, 5), new THREE.MeshPhongMaterial({color: 0x888888})));
            const nose = new THREE.Mesh(new THREE.ConeGeometry(0.75, 2.5, 4), new THREE.MeshPhongMaterial({color: color}));
            nose.rotation.x = Math.PI/2; nose.rotation.y = Math.PI/4; nose.position.z = 3.75; g.add(nose);
            const wing = new THREE.Mesh(new THREE.BoxGeometry(8, 0.2, 3), new THREE.MeshPhongMaterial({color: 0x666666}));
            wing.position.set(0, 0, -0.5); g.add(wing);
            return g;
        }
        ship.add(createShip(0x00ffcc));

        // --- ONLINE LOGIC ---
        if(isOnline) {
            socket.on('currentPlayers', (players) => { Object.keys(players).forEach(id => { if(id!==socket.id) addOther(id, players[id]); }); updateOnline(); });
            socket.on('newPlayer', (data) => { addOther(data.id, data.player); updateOnline(); });
            socket.on('playerMoved', (data) => { if(otherPlayers[data.id]) { otherPlayers[data.id].position.set(data.x, data.y, data.z); otherPlayers[data.id].quaternion.set(data.qx, data.qy, data.qz, data.qw); } });
            socket.on('playerDisconnected', (id) => { if(otherPlayers[id]) { scene.remove(otherPlayers[id]); delete otherPlayers[id]; updateOnline(); } });
            socket.on('youDied', () => { 
                document.getElementById('msg-hit').style.display='block'; 
                ship.position.set(0,5,0); ship.rotation.set(0,0,0); speed=0; fuel=100;
                audioSys.explode();
                setTimeout(()=>document.getElementById('msg-hit').style.display='none', 2000);
            });
        }
        function addOther(id, data) { const o = createShip(data.color); o.position.set(data.x,data.y,data.z); scene.add(o); otherPlayers[id]=o; }
        function updateOnline() { document.getElementById('online-status').innerText = "ONLINE: " + (Object.keys(otherPlayers).length+1); }

        // --- CONTROLES (TECLADO + TOUCH) ---
        const keys = { w:false, s:false, a:false, d:false, space:false, fire:false };
        
        // Teclado
        window.addEventListener('keydown', e => { 
            const k = e.key.toLowerCase();
            if(k==='w') keys.w=true; if(k==='s') keys.s=true; if(k==='a') keys.a=true; if(k==='d') keys.d=true; if(e.code==='Space') keys.space=true; 
        });
        window.addEventListener('keyup', e => { 
            const k = e.key.toLowerCase();
            if(k==='w') keys.w=false; if(k==='s') keys.s=false; if(k==='a') keys.a=false; if(k==='d') keys.d=false; if(e.code==='Space') keys.space=false; 
        });

        // Touch (Mobile)
        function bindTouch(id, key) {
            const el = document.getElementById(id);
            el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
            el.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
        }
        bindTouch('btn-up', 'w');
        bindTouch('btn-down', 's');
        bindTouch('btn-left', 'a');
        bindTouch('btn-right', 'd');
        bindTouch('btn-turbo', 'space');
        
        const btnFire = document.getElementById('btn-fire');
        btnFire.addEventListener('touchstart', (e) => { e.preventDefault(); shoot(); });
        btnFire.addEventListener('mousedown', (e) => { e.preventDefault(); shoot(); });

        // --- START GAME (FIX MOBILE) ---
        const blocker = document.getElementById('blocker');
        const startGame = (e) => {
            if(e.type === 'touchstart') e.preventDefault(); 
            audioSys.init();
            
            // SÃ³ pede pointer lock se NÃƒO for touch (PC)
            if(!('ontouchstart' in window)) document.body.requestPointerLock();
            
            blocker.style.display = 'none';
            isLocked = true; // Inicia o loop
        };
        blocker.addEventListener('click', startGame);
        blocker.addEventListener('touchstart', startGame);

        // --- GAMEPLAY VARS ---
        let speed = 0, fuel = 100, shotTimer = 0, isLocked = false;
        const bullets = [], particles = [];
        let camRadius = 50, camTheta = Math.PI, camPhi = Math.PI/3;

        // Mouse Look (PC)
        document.addEventListener('mousemove', e => {
            // SÃ³ mexe a camera se nÃ£o for touch ou se tiver lock
            if(!isLocked) return;
            const invert = (ship.position.y > 64) ? -1 : 1;
            camTheta -= e.movementX * 0.002 * invert;
            camPhi = Math.max(0.1, Math.min(Math.PI-0.1, camPhi - e.movementY * 0.002));
        });
        // Click Shoot (PC)
        document.addEventListener('mousedown', (e) => { 
            // Ignora cliques nos controles virtuais
            if(e.target.classList.contains('btn') || e.target.classList.contains('action-btn')) return;
            if(isLocked) shoot(); 
        });

        function shoot() {
            if(shotTimer > 0) return;
            audioSys.shoot(); shotTimer = 60; 
            const b = new THREE.Mesh(new THREE.SphereGeometry(0.4), new THREE.MeshBasicMaterial({color:0xff0000}));
            b.position.copy(ship.position);
            b.userData = { vel: new THREE.Vector3(0,0,1).applyQuaternion(ship.quaternion).normalize(), life: 100 };
            scene.add(b); bullets.push(b);
        }

        // --- LOOP PRINCIPAL ---
        function animate() {
            requestAnimationFrame(animate);
            if(!isLocked) return;

            // Controles
            if(keys.w) ship.rotateX(0.02); if(keys.s) ship.rotateX(-0.02);
            if(keys.a) ship.rotateY(0.025); if(keys.d) ship.rotateY(-0.025);

            const thrust = keys.space && fuel > 0;
            if(thrust) { 
                speed += 0.005; fuel -= 0.15; 
                const p = new THREE.Mesh(new THREE.BoxGeometry(0.3,0.3,0.3), new THREE.MeshBasicMaterial({color:0xffff00}));
                // Spawn atrÃ¡s da nave (calculo global)
                ship.updateMatrixWorld();
                const pos = new THREE.Vector3(0,0,-3.5).applyMatrix4(ship.matrixWorld);
                p.position.copy(pos);
                scene.add(p); particles.push({m:p, l:60});
            } else { speed *= 0.99; }
            if(speed > 0.25) speed = 0.25;
            
            ship.translateZ(speed);
            audioSys.updateEngine(thrust);

            // Gravidade / Planar
            const y = ship.position.y;
            const topWorld = y > 64;
            let gravity = Math.max(0, 0.025 - (speed * 0.12)); 
            if(y > 40 && y < 88) gravity = 0;

            if(!topWorld) { ship.position.y -= gravity; camera.up.set(0,1,0); }
            else { ship.position.y += gravity; camera.up.set(0,-1,0); }

            // Limites
            if(ship.position.y < 2) ship.position.y=2; if(ship.position.y>126) ship.position.y=126;
            if(Math.abs(ship.position.x)>64) ship.position.x = Math.sign(ship.position.x)*64;
            if(Math.abs(ship.position.z)>64) ship.position.z = Math.sign(ship.position.z)*64;

            // Abastecimento
            const dist = Math.sqrt(ship.position.x**2 + ship.position.z**2);
            const onBase = (dist < 12) && ((!topWorld && y < 8) || (topWorld && y > 120));
            document.getElementById('msg-base').style.display = (onBase && speed < 0.1) ? 'block' : 'none';
            if(onBase && speed < 0.1) fuel = Math.min(100, fuel+0.5);

            // Sync
            if(isOnline && socket) socket.emit('playerMovement', { x:ship.position.x, y:ship.position.y, z:ship.position.z, qx:ship.quaternion.x, qy:ship.quaternion.y, qz:ship.quaternion.z, qw:ship.quaternion.w });

            // Bullets & Particles
            if(shotTimer>0) shotTimer--;
            for(let i=bullets.length-1; i>=0; i--) {
                bullets[i].position.add(bullets[i].userData.vel); bullets[i].userData.life--;
                // Colisao PVP
                if(isOnline) {
                    Object.keys(otherPlayers).forEach(id => {
                        if(bullets[i].position.distanceTo(otherPlayers[id].position) < 3) {
                            socket.emit('playerHit', id); bullets[i].userData.life=0;
                        }
                    });
                }
                if(bullets[i].userData.life <= 0) { scene.remove(bullets[i]); bullets.splice(i,1); }
            }
            for(let i=particles.length-1; i>=0; i--) {
                particles[i].l--; particles[i].m.scale.multiplyScalar(0.95);
                if(particles[i].l <= 0) { scene.remove(particles[i].m); particles.splice(i,1); }
            }

            // Camera
            const cx = ship.position.x + camRadius * Math.sin(camPhi) * Math.sin(camTheta);
            const cy = ship.position.y + camRadius * Math.cos(camPhi);
            const cz = ship.position.z + camRadius * Math.sin(camPhi) * Math.cos(camTheta);
            camera.position.set(cx, cy, cz); camera.lookAt(ship.position);

            document.getElementById('fuel-bar').style.width = fuel + '%';
            document.getElementById('laser-bar').style.width = Math.max(0, (1 - shotTimer/60)*100) + '%';

            renderer.render(scene, camera);
        }
        animate();
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
    </script>
</body>
</html>
